---
title: "PIP-FUCCI_script"
author: "Tianji Yu"
date: "2023-06-26"
output: html_document
---

## Description

This script takes following files as inputs: (1) image j output csv files containing PIP-FUCCI (PF) intensities and x y coordinates of each EC nucleus from a neonatal retina (nuclear mask generated by ERG channel), (2) x y coordinates of manually drawn polygons of primary arteries (PA), arterioles (Art), primary veins (PV), venules (Ven), and angiogenic front capillaries (AFC), and (3) manually recorded tip cell (Tip) ID and annotations (each nucleus was assigned a specific number when generating ERG mask and tip cell ID and cell cycle phase based on PF colors were manually assigned to validate the accuracy of this pipeline).

The script assigns each nucleus to a specific vascular zone (the unassigned cells were set to MC, mature capillaries). Based on the PF intensities of each EC, they are assigned as G0G1 (mVenus+mCherry-), S (mVenus-mCherry+), or G2 phases (mVenus+mCherry+). The script then calculates % of EC in cell cycle phase for different vascular zones.

Retinas were distinguished by litter number (e.g., 571) followed by pup number (e.g., -6) This script would use retina "A1_571-6" as an example for illustration. Each Retina has it's own script, and tip cell annotation file

## First, Let's load all the data files needed for analysis
```{r}
# Load tip cell annotations
Tip <- read.csv("A1_751_6_tip_cell_annotation.csv")
print(head(Tip))
```

```{r}
# Get tip cell IDs
tip_ID <- Tip$ROI_ID

# Load PIP-FUCCI mCherry and mVenous intensities respectively
mC <- read.csv('Stitch_A1_571_6.oir_mCherry_intensity.csv')
mV <- read.csv('Stitch_A1_571_6.oir_mVenus_intensity.csv')
# Each data has five columns
#   -"ROI_ID" is the unique ID assigned to each cell
#   -"Area" is" the area of the EC nucleus, 
#   -"Mean" is the mean fluorescence intensity of each EC nucleus
#   -"X" and "Y" are the x/y coordinates of each EC nulceus
print(head(mC))
```

```{r}
# The mean intensities of mCherry and mVenous are linear. First, log-transform the "Mean" column of "mC" and "mV" data frame. Combine information together into a new data frame "int"
int <- cbind(mC[,c(1:2,4:5)],(log2(mC[,3] + 1)),(log2(mV[,3] + 1))) 
colnames(int) <- c("ROI_ID","ROI_area","X_um","Y_um","Mean_Int_mCherry","Mean_Int_mVenus")
print(head(int))
```

```{r}
# Load data of polygons drawn for vascular zonation
poly <- read.table('A1-751-6-Vacular_Zonation_Original_polygon_coordinates.txt', header = TRUE)
print(head(poly, n=15))
```

## Prepare polygon data frame for vascular zonation
```{r}
# Extract ROI information from the "RetinaID_VasZone" column in the "poly" data frame.
poly$Roi <- sapply(strsplit(as.character(poly$RetinaID_VasZone), "_"), function(x) x[2])
# Extract Retina information from the "RetinaID_VasZone" column in the "poly" data frame.
poly$Retina <- sapply(strsplit(as.character(poly$RetinaID_VasZone), "_"), function(x) paste(x[2], x[3], sep = "_"))
# Extract Vascular Zonation information from the "RetinaID_VasZone" column.
poly$VasZone <- sub(".*_(.*)$", "\\1", as.character(poly$RetinaID_VasZone))
poly$Polygon <- paste0(poly$VasZone, poly$Vessel)
# Convert polygon coordinates to um because the polygon coordinates were in pixels but nucleus coordinates were in um, need to convert it
# The number can be different for different scope and magnification. Modify when needed.
poly[,2:3] <- poly[,2:3]*0.62145
```

## Now let's assign vascular zones with polygon data

```{r}
### We begin with assigning vascular zones. (PA/PV/Art/Ven/AFC/MC/Tip)
# --------------------------------------------------------------------------------
# Load "secr" package
library(secr)

# Create a column called "VasZone" in "int" data frame to indicate the vascular zone each nucleus belongs to. First, assign "MC" to all rows (each row is a unique nucleus) in the "VasZone" column because nucleus not assigned during vascular zone assignment are MC (i.e. nuclues not in any polygons of PA/PV/Art/Ven/AFC/Tip are MC)
int$VasZone <- "MC"

# Assign the column "Polygon" in the data frame "poly" as a factor variable.
poly$Polygon <- factor(poly$Polygon)

# First, assign AFC, Art, PA, PV and Ven with each vascular zone's polygon coordinates. 
for (i in levels(poly$Polygon)){
  vas_zone <- gsub("[0-9]", "", i)
  temp <- pointsInPolygon(int[,3:4],poly[poly$Polygon == i,2:3])
  #AC now bundled into MC or AFC so exclude it from assignment
  if (sum(temp != 0) && (vas_zone != "AC")){
    #if you want to check assingments
    #print(paste("Assigning nucleus in polygon ", i, " to: ", vas_zone))
    int[temp,]$VasZone <- vas_zone
  }else{
  }
}

# Then, assign tip cells with "tip_ID"
int[tip_ID,]$VasZone <- "tip"

# View vascular zone assignment result
table(int$VasZone)
```

## Assign cell cycle phase by PF fluorescence

```{r}
# Load "ggplot2" package
library(ggplot2)
# Find polygons that makes sense. Very likely the polygon will change for different retinas!
CC_poly=data.frame(x=c(8.5,8.5,10,9.75,8.5, 9.35,9.6,9.75,12,12,9.35, 9.75,10,12,12,9.75), y=c(7.5,12,12,8.7,7.5, 6.5,8.56,8.7,8,6.5,6.5, 8.7,12,12,8,8.7), t=c('G0G1','G0G1','G0G1','G0G1','G0G1',  'S','S','S','S','S','S', 'G2M','G2M','G2M','G2M','G2M'))

# Check the polygon on a cell density plot (just like a flow cytometry plot) and adjust the polygon if needed.
ggplot(int, aes(Mean_Int_mCherry, Mean_Int_mVenus)) + 
  geom_bin2d(bins = 100, aes(fill = ..ncount..)) +
  scale_fill_continuous(type = "viridis") +
  xlim(8,12) +
  ylim(6.5,12) +
  geom_polygon(data=CC_poly, mapping=aes(x=x, y=y, group=t),color="red",alpha=0)

# Assign cell cycle stage for each data point (each data point stands for a unique nucleus) from the polygon we drew under the "CCphase" column of the "int" data frame
data <- int[,5:6]
colnames(data) <- c("x","y")
G0G1_cells <- pointsInPolygon(data,CC_poly[CC_poly$t == "G0G1",1:2])
S_cells <- pointsInPolygon(data,CC_poly[CC_poly$t == "S",1:2])
G2M_cells <- pointsInPolygon(data,CC_poly[CC_poly$t == "G2M",1:2])

int$CCphase <- "DN"
int[G0G1_cells,]$CCphase <- "G0G1"
int[S_cells,]$CCphase <- "S"
int[G2M_cells,]$CCphase <- "G2M"

# Update the tip cell cell cycle phase information in the "CCphase" column of the "int" data frame with manual assignment of tip cell cell cycle phase information in the "phase" column of the "Tip" data frame. This data can also be used to calculate the accuracy of the cell cycle phase assignment by this script and validate how good the sript performs compared to the gold standard (manual assignment).
matched_indices <- match(Tip$ROI_ID, int$ROI_ID)
int$CCphase[matched_indices] <- Tip$phase

### Last, exclude non-EC cells
# Load polygon that surrounds the whole retina
EC_poly <- read.table("Vacular_Region_polygon_coordinates.txt",header = TRUE)
# Excluding non-EC cells or EC from vistreous vessels on the edge of the retina by removing nucleus that are not in the polygon surrounding the vascular region of retina
EC_ID <- pointsInPolygon(int[,3:4],EC_poly[,2:3])
int <- int[EC_ID,]

#Save the density plot with polygon with non-EC excluded
plot1 <- ggplot(int, aes(Mean_Int_mCherry, Mean_Int_mVenus)) + 
  geom_bin2d(bins = 100, aes(fill = ..ncount..)) +
  scale_fill_continuous(type = "viridis") +
  xlim(8,12) +
  ylim(6.5,12) +
  geom_polygon(data=CC_poly, mapping=aes(x=x, y=y, group=t),color="red",alpha=0)
plot1

# Set a different color for a different stage in cell cycle
cols <- c("DN" = "gray", "G0G1" = "chartreuse3", "S" = "red", "G2M" = "orange")

# Draw the densiy plot with cell cycle phase information on it
plot2 <- ggplot(int, aes(Mean_Int_mCherry, Mean_Int_mVenus)) + 
  geom_point(aes(color=factor(CCphase))) +
  scale_color_manual(values=cols)+
  geom_polygon(data=CC_poly, mapping=aes(x=x, y=y, group=t),color="black",alpha=0) +
  xlim(8,12) +
  ylim(6.5,12) +
  theme_classic()+
  theme(legend.position = "right")
plot2
```

## Calculate the proportion of cells in each cell cycle phase from different vascular zone

```{r}
# Define the order of the levels for each vascular zone
VasZone_levels <- c("PA", "PV", "Art","Ven","MC","AFC","tip","all")

# First calculate % of EC in each CC phase for each vascular zone
#--------------------------------------
# Create a matrix called "freq" that tabulates the count of cells in each cell phase from each different vascular zone category
#   -Each column is a different vascular zone
#   -Each row is a different cell cycle phase
freq <- cbind(table(int$CCphase,int$VasZone))
# Reorder the rows of the "freq" as following: "DN", "G0G1", "S", "G2M"
freq <- freq[c(1:2,4,3),]
# Add a new column to the "freq" matrix called "all" which sums count of cells in each row (each cell cycle phase)
freq <- cbind(freq, all = rowSums(freq))
# Reorder the columns of the "freq" as following: "PA", "PV", "Art","Ven","MC","AFC","tip","all"
freq <- freq[, VasZone_levels]
# Calculate the proportion of cells in each cell cycle phase from different vascular zones
per <- prop.table(as.matrix(freq),2)*100

# Calculate a version without double negatives
freq_non_DN <- freq[2:4,]
per_non_DN <- prop.table(as.matrix(freq_non_DN),2)*100

# Now calculate G2G1 ratio
#--------------------------------------
# Calculate the G2G1 ratio and round the result to 2 decimal numbers
freq_G2G1 <- freq[4,]/freq[2,]
freq_G2G1 <- round(freq_G2G1, 2)
# Create a data frame to that tabulates the G2G1 ratio for each cell cycle phase from different vascular zones
df <- data.frame(Index = colnames(freq), Ratio = freq_G2G1)
df$category <- factor(df$Index, levels = VasZone_levels)
df <- df[order(df$category),]

# Calculate the G2G1 ratio with DN cells excluded 
freq_G2G1_non_DN <- freq_non_DN[3,]/freq_non_DN[1,]
freq_G2G1_non_DN <- round(freq_G2G1_non_DN, 2)
df_non_DN <- data.frame(Index = colnames(freq_non_DN), Ratio = freq_G2G1_non_DN)
df_non_DN$category <- factor(df_non_DN$Index, levels = VasZone_levels)
df_non_DN <- df_non_DN[order(df_non_DN$category),]

# Then calculate SG1 ratio in VasZone
#--------------------------------------
freq2_SG1 <- freq[3,]/freq[2,]
freq2_SG1 <- round(freq2_SG1, 2)
df2 <- data.frame(Index = colnames(freq), Ratio = freq2_SG1)
df2$category <- factor(df2$Index, levels = VasZone_levels)
df2 <- df2[order(df2$category),]

# Calculate the SG1 ratio with DN cells excluded 
freq2_SG1_non_DN <- freq_non_DN[2,]/freq_non_DN[1,]
freq2_SG1_non_DN <- round(freq2_SG1_non_DN, 2)
df2_non_DN <- data.frame(Index = colnames(freq_non_DN), Ratio = freq2_SG1_non_DN)
df2_non_DN$category <- factor(df2_non_DN$Index, levels = VasZone_levels)
df2_non_DN <- df2_non_DN[order(df2_non_DN$category),]

# Finally calculate SG2 ratio in VasZone
#--------------------------------------
freq3_SG2 <- freq[3,]/freq[4,]
freq3_SG2 <- round(freq3_SG2, 2)
df3 <- data.frame(Index = colnames(freq), Ratio = freq3_SG2)
df3$category <- factor(df3$Index, levels = VasZone_levels)
df3 <- df3[order(df3$category),]

# Calculate the SG2 ratio with DN cells excluded 
freq3_SG2_non_DN <- freq_non_DN[2,]/freq_non_DN[3,]
freq3_SG2_non_DN <- round(freq3_SG2_non_DN, 2)
df3_non_DN <- data.frame(Index = colnames(freq_non_DN), Ratio = freq3_SG2_non_DN)
df3_non_DN$category <- factor(df3_non_DN$Index, levels = VasZone_levels)
df3_non_DN <- df3_non_DN[order(df3_non_DN$category),]

#Visualize the cell proportions, G2G1 ratios, SG1 ratios, and SG2 ratios in bar plots
p3<-barplot(per,names.arg = colnames(per), xlab = "vessel type/region", ylab = "% in Erg+ cells", col = cols,main = "cell cycle phase distribution in different regions of the retina",
        xlim=c(0, ncol(per) + 2),legend.text=TRUE,args.legend=list(x=ncol(per) + 2,y=max(colSums(per)),bty = "n"))

p4<-barplot(per_non_DN,names.arg = colnames(per_non_DN), xlab = "vessel type/region", ylab = "% in PF+ cells", col = cols[2:4],main = "cell cycle phase distribution in different regions of the retina",
        xlim=c(0, ncol(per_non_DN) + 2),legend.text=TRUE,args.legend=list(x=ncol(per_non_DN) + 2,y=max(colSums(per_non_DN)),bty = "n"))

p5<-ggplot(df, aes(x = category, y = Ratio)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = Ratio), vjust = -0.5) +
  labs(x = "Category") +
  ylab("G2/G1 Ratio") +
  theme_minimal()

p6<-ggplot(df2, aes(x = category, y = Ratio)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = Ratio), vjust = -0.5) +
  labs(x = "Category") +
  ylab("S/G1 Ratio") +
  theme_minimal()

p7<-ggplot(df3, aes(x = category, y = Ratio)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = Ratio), vjust = -0.5) +
  labs(x = "Category") +
  ylab("S/G2 Ratio") +
  theme_minimal()
plots <- list(p3, p4, p5, p6, p7)
plots
```

## Export all the plots and data frames

```{r}
# Let the variable "retina_ID" hold the retina name for easier naming of the following plots
retina_ID <- "A1_751_6"

# Save all the plots with a proper name
pdf(paste0(retina_ID,"_density_plot.pdf"), width = 6, height = 4, useDingbats=FALSE)
plot1
dev.off()

pdf(paste0(retina_ID,"_scatter_plot.pdf"), width = 6, height = 4, useDingbats=FALSE)
plot2
dev.off()

pdf(paste0(retina_ID,"_barplot_CCphase_by_vas_type.pdf"), width = 12, height = 6, useDingbats=FALSE)
plots
dev.off()

write.csv(freq, paste0(retina_ID,"_frequency_sum.csv"))
write.csv(freq_non_DN, paste0(retina_ID,"_frequency_DN_excluded.csv"))
write.csv(per, paste0(retina_ID,"_percentage_sum.csv"))
write.csv(per_non_DN, paste0(retina_ID,"_percentage_DN_excluded.csv"))
write.csv(df, paste0(retina_ID,"_G2G1_Score_CCphase_by_diff_region_percentage_DN_included.csv"))
write.csv(df_non_DN, paste0(retina_ID,"_G2G1_Score_CCphase_by_diff_region_percentage_DN_excluded.csv"))
write.csv(df2, paste0(retina_ID,"_SG1_Score_CCphase_by_diff_region_percentage_DN_included.csv"))
write.csv(df2_non_DN, paste0(retina_ID,"_SG1_Score_CCphase_by_diff_region_percentage_DN_excluded.csv"))
write.csv(df3, paste0(retina_ID,"_SG2_Score_CCphase_by_diff_region_percentage_DN_included.csv"))
write.csv(df3_non_DN, paste0(retina_ID,"_SG2_Score_CCphase_by_diff_region_percentage_DN_excluded.csv"))
write.csv(int,paste0(retina_ID,"_results_summary.csv"))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
